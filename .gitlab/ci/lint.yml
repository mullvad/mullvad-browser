.base:
  stage: lint
  interruptible: true
  variables:
    MOZBUILD_STATE_PATH: "$CI_PROJECT_DIR/.cache/mozbuild"
  cache:
    paths:
      - node_modules
      - .cache/mozbuild
    # Store the cache regardless on job outcome
    when: 'always'
    # Share the cache throughout all pipelines running for a given branch
    key: $CI_COMMIT_REF_SLUG

eslint:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py eslint
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        # Files that are likely audited.
        - '**/*.js'
        - '**/*.jsm'
        - '**/*.json'
        - '**/*.jsx'
        - '**/*.mjs'
        - '**/*.sjs'
        - '**/*.html'
        - '**/*.xhtml'
        - '**/*.xml'
        - 'tools/lint/eslint.yml'
        # Run when eslint policies change.
        - '**/.eslintignore'
        - '**/*eslintrc*'
        # The plugin implementing custom checks.
        - 'tools/lint/eslint/eslint-plugin-mozilla/**'
        - 'tools/lint/eslint/eslint-plugin-spidermonkey-js/**'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

stylelint:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py stylelint
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        # Files that are likely audited.
        - '**/*.css'
        - 'tools/lint/styleint.yml'
        # Run when stylelint policies change.
        - '**/.stylelintignore'
        - '**/*stylelintrc*'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

py-black:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py black
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        # The list of extensions should match tools/lint/black.yml
        - '**/*.py'
        - '**/moz.build'
        - '**/*.configure'
        - '**/*.mozbuild'
        - 'pyproject.toml'
        - 'tools/lint/black.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

py-ruff:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py ruff
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.py'
        - '**/*.configure'
        - '**/.ruff.toml'
        - 'pyproject.toml'
        - 'tools/lint/ruff.yml'
        - 'tools/lint/python/ruff.py'
        - 'tools/lint/python/ruff_requirements.txt'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

yaml:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py yaml
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.yml'
        - '**/*.yaml'
        - '**/.ymllint'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

shellcheck:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py shellcheck
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.sh'
        - 'tools/lint/shellcheck.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

clang-format:
  extends: .base
  image: $IMAGE_PATH
  script:
    - ./mach configure --without-wasm-sandboxed-libraries --with-base-browser-version=0.0.0
    - .gitlab/ci/scripts/run_linters.py clang-format
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.cpp'
        - '**/*.c'
        - '**/*.cc'
        - '**/*.h'
        - '**/*.m'
        - '**/*.mm'
        - 'tools/lint/clang-format.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

rustfmt:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py rustfmt
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.rs'
        - 'tools/lint/rustfmt.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

fluent-lint:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py fluent-lint
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.ftl'
        - 'tools/lint/fluent-lint.yml'
        - 'tools/lint/fluent-lint/exclusions.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

localization:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py l10n
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/locales/en-US/**'
        - '**/l10n.toml'
        - 'third_party/python/compare-locales/**'
        - 'third_party/python/fluent/**'
        - 'tools/lint/l10n.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

mingw-capitalization:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py mingw-capitalization
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.cpp'
        - '**/*.cc'
        - '**/*.c'
        - '**/*.h'
        - 'tools/lint/mingw-capitalization.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

mscom-init:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py mscom-init
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.cpp'
        - '**/*.cc'
        - '**/*.c'
        - '**/*.h'
        - 'tools/lint/mscom-init.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

file-whitespace:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py file-whitespace
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.c'
        - '**/*.cc'
        - '**/*.cpp'
        - '**/*.css'
        - '**/*.dtd'
        - '**/*.idl'
        - '**/*.ftl'
        - '**/*.h'
        - '**/*.html'
        - '**/*.md'
        - '**/*.properties'
        - '**/*.py'
        - '**/*.rs'
        - '**/*.rst'
        - '**/*.webidl'
        - '**/*.xhtml'
        - 'tools/lint/file-whitespace.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

test-manifest:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py test-manifest-alpha test-manifest-disable test-manifest-skip-if
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.ini'
        - 'python/mozlint/**'
        - 'tools/lint/**'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'

trojan-source:
  extends: .base
  image: $IMAGE_PATH
  script:
    - .gitlab/ci/scripts/run_linters.py trojan-source
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        # List copied from: taskcluster/ci/source-test/mozlint.yml
        #
        - '**/*.c'
        - '**/*.cc'
        - '**/*.cpp'
        - '**/*.h'
        - '**/*.py'
        - '**/*.rs'
        - 'tools/lint/trojan-source.yml'
    # Run job whenever a commit is merged to a protected branch
    - if: $CI_COMMIT_REF_PROTECTED == 'true'
